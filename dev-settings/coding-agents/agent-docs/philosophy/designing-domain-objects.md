# ドメインオブジェクトの設計哲学

## ドメインオブジェクトの批判的検討 — 脱構築とスキーマ理論によるリファインメント

### 目的

実装パターンは「どう実装するか（How）」を示す。しかし「そのモデルは本当に正しいか？」という問いには答えない。

ドメインオブジェクトは現実の写しではなく、ある視点から現実を **切り取った** 構築物である。切り取り方には必ず前提がある。その前提が無自覚なまま実装に落とし込まれると、モデルは特定のユースケースに偏り、変更に脆くなる。

本ドキュメントでは、哲学の **脱構築** と認知科学の **スキーマ理論** を道具として、ドメインオブジェクトに埋め込まれた暗黙の前提を可視化し、モデルの質を高める方法論を示す。

実装パターンと具体的な適用例は `agent-docs/examples/domain-objects.md` を参照。

### 理論的背景

#### 脱構築（Déconstruction）— ジャック・デリダ

デリダが提唱した脱構築は、テキストや構造に内在する前提を内側から解きほぐす思考法である。「壊す」のではなく、構造が自らの前提によって揺らぐ地点を見出す。

##### 二項対立（binary opposition）

西洋形而上学は知を二項対立で組織化する — 現前/不在、自然/文化、本質/偶有。デリダはこれらの対立において一方が常に特権化されていることを示した。

ドメインオブジェクトにおける二項対立は、enumの状態（active/inactive）、boolean型フィールド（isFreeShipping）、型階層（Admin/User）として現れる。特権化された項がモデルの「正常系」を規定し、もう一方を例外や逸脱として周縁に押しやる。

##### 差延（différance）

デリダの造語で、「異なること（differ）」と「遅延すること（defer）」を重ね合わせた概念。意味は単一の記号に自足せず、他の記号との差異の連鎖のなかで常に先送りされる。

ドメインオブジェクトにおいて、あるエンティティ（例: Order）の意味はそれ自体に内在しない。Request、Invoice、Shipment、Refundといった隣接概念との **差異** のなかで、Orderの輪郭が浮かび上がる。Orderの境界を定義するとは、これらの差異の連鎖のどこに線を引くかを決めることである。

##### 痕跡（trace）

あらゆる概念は、それが「でないもの」の痕跡を内に含む。Orderは「まだ注文でないもの」（カート、ウィッシュリスト）と「もはや注文でないもの」（返品、取消）の痕跡を帯びている。痕跡はモデルに現れない概念 — つまり **モデルが排除したもの** を指し示す。

##### ロゴス中心主義（logocentrism）の解体

構造には必ず「中心」が仮定される。ドメインオブジェクトでは集約ルートが中心を担い、他のオブジェクトはその従属物として配置される。ロゴス中心主義の解体とは、その中心の必然性を問うことである — なぜOrderが集約ルートであり、OrderItemではないのか？中心を入れ替えたとき、モデルはどう変わるか？

#### スキーマ理論（Schema Theory）— 認知科学

スキーマ理論は、人間が知識を組織化し、新しい情報を処理する際に用いる認知的枠組み（スキーマ）を研究する。バートレット（1932）が記憶の再構成性を示し、ピアジェが発達段階論のなかで精緻化し、ラメルハート（1980）が情報処理モデルとして定式化した。

##### スキーマの構造と活性化

スキーマは特定の領域に関する構造化された知識のまとまりで、文脈によって活性化される。「レストラン」というスキーマが活性化されると、入店→着席→注文→食事→会計という一連の期待が生じる。

ドメインモデリングにおいて、開発者やドメインエキスパートは自身の職業的背景や経験に基づくスキーマを持ち込む。ECサイトのドメインエキスパートが持つ「注文」スキーマと、物流担当者が持つ「注文」スキーマは異なる構造をしている。どちらのスキーマが支配的かによって、モデルの形が変わる。

##### 同化（assimilation）

ピアジェの概念で、新しい情報を既存のスキーマに取り込むプロセス。ドメインモデリングでは、新しい要件を既存のモデル構造に押し込めようとする力として作用する。「Orderにステータスをもう一つ追加すればいい」という判断は、既存のOrderスキーマへの同化である。モデルがその要件の本質を自然に表現できているかどうかは問われない。

##### 調節（accommodation）

同化では処理できない情報に直面したとき、スキーマ自体を変更するプロセス。ドメインモデリングにおける調節は、モデルの根本的な再構造化に対応する — エンティティの分割、集約境界の変更、新しいバウンデッドコンテキストの導出。同化に比べてコストが高いため、人は同化を選好するバイアスを持つ。

##### プロトタイプ効果

ロッシュのプロトタイプ理論に基づく現象で、カテゴリは「典型例（プロトタイプ）」を中心に組織化される。「鳥」のプロトタイプはスズメであり、ペンギンではない。

ドメインオブジェクトにおいて、モデルはプロトタイプ的なユースケース（典型的な注文、典型的なユーザー）を中心に設計される。非プロトタイプ的なケース（大量一括注文、法人顧客、国際取引）は「例外処理」として扱われ、モデルの構造には反映されない。しかし、ビジネスの成長に伴い、非プロトタイプ的なケースが増加すると、モデルは深刻な歪みを抱える。

### 適用ワークフロー

#### Phase 1: 脱構築 — モデルの前提を暴く

##### Step 1: 二項対立の抽出

モデル内のすべてのenum型、booleanフィールド、型階層を列挙する。それぞれについて以下を問う:

- この対立のどちらが「正常」で、どちらが「例外」か？
- その特権化は何の前提に基づいているか？
- 対立のどちらにも収まらない状態は存在しないか？

##### Step 2: 中心と周縁の転倒

モデルの集約ルート（中心）を特定し、以下を問う:

- なぜこのエンティティが中心なのか？それは技術的理由か、ビジネス的理由か？
- 現在「周縁」に置かれているエンティティを中心に据えたモデルはどうなるか？
- 別のアクター（エンドユーザー、管理者、外部システム）から見たとき、中心は同じか？

##### Step 3: 痕跡と排除の追跡

各エンティティについて以下を問う:

- このエンティティの「前」にあるもの（前段階の状態）は何か？それはモデルに存在するか？
- このエンティティの「後」にあるもの（後続の状態）は何か？それはモデルに存在するか？
- 暗黙的に前提とされているが、明示的にモデル化されていない概念は何か？

#### Phase 2: スキーマ理論 — 認知的枠組みを問い直す

##### Step 1: 支配的スキーマの同定

- このモデルが暗黙に採用しているメタファー（比喩）は何か？
- そのメタファーを「当たり前」にしている関係者は誰か？（職種、立場、経験）
- 同じドメインを別のメタファーで捉えることはできるか？

##### Step 2: 同化バイアスの検出

以下のシグナルを探す:

- 本来の意味とずれた名前が付けられているフィールドやメソッド
- 過度に複雑なバリデーションルール（概念を無理にフィットさせた痕跡）
- 「特殊ケース」「例外処理」が集中する箇所
- 「一旦これで」と妥協した設計判断

##### Step 3: 調節によるモデル再構成

- 代替スキーマ（メタファー）を提案し、各スキーマのもとでモデルを再構築する
- エッジケースが最も自然に表現されるスキーマを評価する
- 調節のコスト（既存コードへの影響範囲）とベネフィット（モデルの表現力向上）を見積もる

### 実践例

本ワークフローをOrderモデルに適用した具体例は `agent-docs/examples/domain-objects.md` の「Order モデルの批判的検討」セクションを参照。

### エージェント用プロンプト集

ドメインオブジェクトのレビュー・設計時に、以下の問いかけを構造的に適用する。

#### 脱構築の問いかけ

1. **二項対立の列挙**: このモデルに含まれるenum型、booleanフィールド、型階層をすべて列挙せよ。各対立において、どちらの項が「正常系」として特権化されているか？
2. **排除の発見**: 各二項対立が排除している状態・概念は何か？対立のどちらにも収まらないケースは存在しないか？
3. **中心の問い直し**: モデルの集約ルート（中心）はどれか？その中心性は技術的制約か、ビジネス的必然か？中心を入れ替えたモデルを描けるか？
4. **痕跡の追跡**: 各エンティティの「前」と「後」に位置する概念は何か？それらはモデルに明示されているか、それとも排除されているか？
5. **暗黙の前提**: 「当たり前すぎてモデルに現れていない」ビジネスルールや概念は何か？
6. **終端の疑い**: モデルの終端状態（最終ステータス、削除済みなど）は本当に終端か？その先に続くビジネスフローはないか？

#### スキーマ理論の問いかけ

1. **メタファーの同定**: このモデルが暗黙に採用しているメタファーは何か？「〇〇とは△△である」の形で言語化せよ
2. **スキーマの出自**: そのメタファーを「自然」にしている関係者は誰か？彼らの職種・立場・経験はどのようなものか？
3. **代替スキーマの構想**: 同じドメインを別のメタファーで捉えるとどうなるか？最低2つの代替スキーマを提案せよ
4. **同化バイアスの検出**: 既存のモデル構造に「無理にフィットさせている」概念はないか？過度に複雑なバリデーション、不自然な命名、例外処理の集中を手がかりに探せ
5. **プロトタイプの偏り**: このモデルが想定する「典型的なケース」は何か？非典型的なケース（大量注文、法人利用、国際取引など）はどう扱われているか？
6. **調節のトリガー**: もしゼロからモデリングし直すとして、同じ構造を選ぶか？選ばないなら、何が調節を妨げているか？（既存コードの慣性、チームの合意コスト、知識の不足）

# ドメインオブジェクトの設計哲学

## ドメインオブジェクトの批判的検討 — 脱構築とスキーマ理論によるリファインメント

### 目的

実装パターンは「どう実装するか（How）」を示す。しかし「そのモデルは本当に正しいか？」という問いには答えない。

ドメインオブジェクトは現実の写しではなく、ある視点から現実を **切り取った** 構築物である。切り取り方には必ず前提がある。その前提が無自覚なまま実装に落とし込まれると、モデルは特定のユースケースに偏り、変更に脆くなる。

本ドキュメントでは、哲学の **脱構築** と認知科学の **スキーマ理論** を道具として、ドメインオブジェクトに埋め込まれた暗黙の前提を可視化し、モデルの質を高める方法論を示す。

本ドキュメントは **思考の地図**（なぜそう問うのか）を提供する。エージェントが実際に適用する問いとその出力形式は [エージェント実行プロトコル](#エージェント実行プロトコル) を参照し、具体的な適用例は `agent-docs/examples/domain-objects.md` を参照すること。

---

### 理論的背景

#### 脱構築（Déconstruction）— ジャック・デリダ

デリダが提唱した脱構築は、テキストや構造に内在する前提を内側から解きほぐす思考法である。「壊す」のではなく、構造が自らの前提によって揺らぐ地点を見出す。

##### 二項対立（binary opposition）

西洋形而上学は知を二項対立で組織化する — 現前/不在、自然/文化、本質/偶有。デリダはこれらの対立において一方が常に特権化されていることを示した。

ドメインオブジェクトにおける二項対立は、enumの状態（`active/inactive`）、boolean型フィールド（`isFreeShipping`）、型階層（`Admin/User`）として現れる。特権化された項がモデルの「正常系」を規定し、もう一方を例外や逸脱として周縁に押しやる。

##### 差延（différance）

デリダの造語で、「異なること（differ）」と「遅延すること（defer）」を重ね合わせた概念。意味は単一の記号に自足せず、他の記号との差異の連鎖のなかで常に先送りされる。

ドメインオブジェクトにおいて、あるエンティティ（例: `Order`）の意味はそれ自体に内在しない。`Request`、`Invoice`、`Shipment`、`Refund` といった隣接概念との **差異** のなかで、`Order` の輪郭が浮かび上がる。`Order` の境界を定義するとは、これらの差異の連鎖のどこに線を引くかを決めることである。

これはモデリング上、**「何をこのエンティティに含めるか」よりも「何をこのエンティティの外に置くか」を問うことがモデルの境界を明確にする**という実践的示唆をもつ。

##### 痕跡（trace）

あらゆる概念は、それが「でないもの」の痕跡を内に含む。`Order` は「まだ注文でないもの」（カート、ウィッシュリスト）と「もはや注文でないもの」（返品、取消）の痕跡を帯びている。痕跡はモデルに現れない概念 — つまり **モデルが排除したもの** を指し示す。

##### ロゴス中心主義（logocentrism）の解体

構造には必ず「中心」が仮定される。ドメインオブジェクトでは集約ルートが中心を担い、他のオブジェクトはその従属物として配置される。ロゴス中心主義の解体とは、その中心の必然性を問うことである — なぜ `Order` が集約ルートであり、`OrderItem` ではないのか？

重要なのは「中心を入れ替えたらどうなるか」で思考を止めないことだ。中心の入れ替えは思考実験に留まらず、**異なるアクター（エンドユーザー、物流担当、外部システム）にとっての集約ルート候補を洗い出し、既存の中心選択が誰の視点を特権化しているかを診断する**ための操作である。

---

#### スキーマ理論（Schema Theory）— 認知科学

スキーマ理論は、人間が知識を組織化し、新しい情報を処理する際に用いる認知的枠組み（スキーマ）を研究する。バートレット（1932）が記憶の再構成性を示し、ピアジェが発達段階論のなかで精緻化し、ラメルハート（1980）が情報処理モデルとして定式化した。

##### スキーマの構造と活性化

スキーマは特定の領域に関する構造化された知識のまとまりで、文脈によって活性化される。「レストラン」というスキーマが活性化されると、入店→着席→注文→食事→会計という一連の期待が生じる。空席のスロットが存在することも重要で、「今日のスープは？」という問いはスロットへの充填として処理される。

ドメインモデリングにおいて、開発者やドメインエキスパートは自身の職業的背景に基づくスキーマを持ち込む。ECサイト担当者の「注文」スキーマは購買意思決定を中心とする。物流担当者の「注文」スキーマは配送オペレーションを中心とする。**どちらのスキーマが支配的かによってモデルの形が変わる**。また、スキーマには必ず「空きスロット」がある — モデルに欠落している概念はこのスロットが埋まっていないことで見えてくる。

##### 同化（assimilation）

ピアジェの概念で、新しい情報を既存のスキーマに取り込むプロセス。ドメインモデリングでは、新しい要件を既存モデル構造に押し込めようとする力として作用する。「`Order` にステータスをもう一つ追加すればいい」という判断は、既存の `Order` スキーマへの同化である。この同化バイアスは **開発者と ドメインエキスパートで異なる形をとる**。開発者は「既存コードへの影響を最小化したい」という技術的惰性から同化を選ぶ。ドメインエキスパートは「これまでの業務フローと整合させたい」という経験的スキーマから同化を選ぶ。バイアスの出所によって、処方箋も変わる。

##### 調節（accommodation）

同化では処理できない情報に直面したとき、スキーマ自体を変更するプロセス。ドメインモデリングにおける調節は、モデルの根本的な再構造化 — エンティティの分割、集約境界の変更、新しいバウンデッドコンテキストの導出 — に対応する。同化に比べてコストが高いため、人は同化を選好するバイアスを持つ。調節が必要な状況を先送りすると、同化の痕跡がモデルに蓄積し、後の変更コストが指数的に増大する。

##### プロトタイプ効果

ロッシュのプロトタイプ理論に基づく現象で、カテゴリは「典型例（プロトタイプ）」を中心に組織化される。「鳥」というカテゴリはスズメを典型例として形成され、ペンギンはカテゴリの周縁に位置づけられる — 鳥であることには変わりないが、「鳥らしさ」が低いと判断される。

ドメインオブジェクトも同様に、プロトタイプ的なユースケース（典型的な個人による単品購入）を中心に設計される。大量一括注文、法人顧客、国際取引、定期購入などは「例外処理」として扱われ、モデルの構造には反映されない。しかしビジネスの成長に伴い、これらの非プロトタイプ的なケースの比率が増加すると、モデルは深刻な歪みを抱える。**プロトタイプ効果が示すのは、「例外が増えた時点で調節が必要」ではなく、「例外がゼロでも設計時点でプロトタイプの偏りを意識すべき」ということである。**

---

### ワークフロー

本ワークフローは **脱構築（Phase 1）→ スキーマ理論（Phase 2）→ 再構成（Phase 3）** の3段階で構成される。各フェーズは独立した作業ではなく、前フェーズの出力物を次フェーズのインプットとして引き継ぐ連鎖として機能する。

```text
Phase 1: 脱構築          Phase 2: スキーマ分析        Phase 3: 再構成
─────────────────        ─────────────────────        ──────────────────
モデルを解体し      →    認知的前提を問い直し     →   代替モデルを評価し
排除を可視化する         支配的スキーマを特定する      調節コストを判断する

出力物:                  出力物:                      出力物:
・排除概念リスト    →    ・支配スキーマの明示   →     ・代替モデル案
・二項対立マップ         ・代替スキーマ案             ・調節コスト試算
・中心性の問い直し       ・同化バイアスの診断         ・推奨アクション
```

#### Phase 1: 脱構築 — モデルの前提を暴く

**目標**: このフェーズで得たいのは「モデルが何を語っているか」ではなく「モデルが何を語らないようにしているか」である。

##### Step 1: 二項対立の抽出と特権化の診断

モデル内のすべての enum 型、boolean フィールド、型階層を列挙する。それぞれについて問う:

- この対立のどちらが「正常」で、どちらが「例外」か？
- その特権化は技術的理由か、ビジネス的理由か、歴史的経緯か？
- 対立のどちらにも収まらない状態は存在しないか？

##### Step 2: 差延の追跡 — 意味を先送りしている隣接概念の発見

各エンティティについて、その意味を「確定させていない」隣接概念を探す:

- このエンティティの意味が曖昧になる境界（隣接するエンティティとの境目）はどこか？
- 「これは `Order` か `Cart` か」「これは `Invoice` か `Order` か」という問いが生じる境界はどこか？
- その境界の曖昧さは設計上のバグか、それとも現実のビジネスの複雑さを反映しているか？

##### Step 3: 痕跡と排除の追跡

各エンティティについて問う:

- このエンティティの「前」にあるもの（前段階の状態）は何か？それはモデルに存在するか？
- このエンティティの「後」にあるもの（後続の状態）は何か？それはモデルに存在するか？
- 暗黙的に前提とされているが、明示的にモデル化されていない概念は何か？
- モデルの終端状態（最終ステータス、削除済みなど）は本当に終端か？その先に続くビジネスフローはないか？

##### Step 4: 中心性の解体 — アクター別集約ルート候補の洗い出し

- 現在の集約ルートは誰の視点を特権化しているか？（開発者、ドメインエキスパート、特定部門）
- 異なるアクター（エンドユーザー、物流担当、会計、外部パートナー）から見たとき、集約ルートは同じか？
- アクターごとの集約ルート候補をリストアップし、現在の選択との差異を記録する。

**Phase 1 の出力物（Phase 2 へのインプット）:**

```text
- 排除されている概念のリスト（前段階・後続状態・暗黙の前提）
- 二項対立マップ（各対立の特権化された項とその根拠）
- 差延マップ（意味が曖昧になる隣接境界のリスト）
- アクター別集約ルート候補表
```

---

#### Phase 2: スキーマ理論 — 認知的枠組みを問い直す

**目標**: Phase 1 で可視化した排除や歪みが、**誰のどんなスキーマ** から生まれているかを診断する。

##### Step 1: 支配的スキーマの同定

- このモデルが暗黙に採用しているメタファーは何か？「〇〇とは△△である」の形で言語化せよ。
- そのメタファーを「当たり前」にしている関係者は誰か？その職種・立場・経験はどのようなものか？
- Phase 1 で発見した排除概念や特権化された二項対立は、どのスキーマから説明できるか？

##### Step 2: 同化バイアスの検出と出所の診断

以下のシグナルを探す:

- 本来の意味とずれた名前が付けられているフィールドやメソッド
- 過度に複雑なバリデーションルール（概念を無理にフィットさせた痕跡）
- 「特殊ケース」「例外処理」が集中する箇所
- 「一旦これで」と妥協した設計判断

発見した同化バイアスそれぞれについて、**誰が同化を選んだか**を診断する:

- **開発者側の同化**: 既存コードへの影響最小化、技術的惰性、実装コストの忌避
- **ドメインエキスパート側の同化**: 既存業務フローへの固執、過去の成功体験のスキーマ適用

バイアスの出所が異なれば、処方箋も異なる。開発者側の同化にはリファクタリングコストの可視化が効く。ドメインエキスパート側の同化にはイベントストーミングやユースケース拡張が効く。

##### Step 3: プロトタイプ偏りの評価

- このモデルが想定する「典型的なケース（プロトタイプ）」は何か？
- Phase 1 で発見した排除概念のうち、非プロトタイプ的なケースはどれか？
- それらの非プロトタイプ的なケースの現在の発生頻度と将来的な増加見込みを評価する。

**Phase 2 の出力物（Phase 3 へのインプット）:**

```text
- 支配スキーマの明文化（「このモデルは〇〇というメタファーで△△の視点から構築されている」）
- 代替スキーマ案（最低2つ）
- 同化バイアス診断表（バイアスの箇所・出所・強度）
- 非プロトタイプ的ケースのリストと将来リスク評価
```

---

#### Phase 3: 再構成 — 代替モデルの評価と調節判断

**目標**: Phase 1・2 の診断を踏まえ、「調節するかどうか」「どこまで調節するか」を判断するための材料を整える。

##### Step 1: 代替スキーマによるモデル再構築

Phase 2 で提案した代替スキーマそれぞれについて:

- 代替スキーマのもとでドメインモデルを概略的に再構築する
- Phase 1 で発見した排除概念がどう扱われるかを確認する
- エッジケースが最も自然に表現されるスキーマを評価する

##### Step 2: 調節コストの見積もり

調節（モデルの根本的再構造化）のコストを以下の軸で評価する:

| 評価軸 | 確認する内容 |
| :--- | :--- |
| **影響エンティティ数** | 変更が波及するエンティティ・バリューオブジェクトの数 |
| **テスト書き換え範囲** | 既存ユニットテスト・統合テストの変更が必要な範囲 |
| **API・インターフェース変更** | 外部システムとの契約変更の有無 |
| **チーム合意コスト** | 変更に必要なドメインエキスパートとの再合意の難度 |
| **段階的移行可能性** | ストラングラーパターン等での段階移行ができるか |

##### Step 3: 推奨アクションの決定

コストとベネフィットを踏まえ、以下のいずれかに分類して記録する:

- **即時調節**: エンティティ分割や新概念の導入を推奨（コスト低・リスク高）
- **段階的調節**: 移行計画を立て、次の機能開発と合わせて調節（コスト中・リスク中）
- **監視継続**: 現状維持しつつ、非プロトタイプ的ケースの発生状況を観測（コスト高・リスク低）

**Phase 3 の最終出力物:**

```text
- 代替モデル案（スキーマごと）
- 調節コスト試算表
- 推奨アクション（即時/段階的/監視継続）とその根拠
```

---

### エージェント実行プロトコル

本セクションはエージェントが実際に実行する問いと、各問いへの期待出力形式を定義する。各フェーズの問いを順に適用し、前フェーズの出力を次フェーズの入力として引き継ぐこと。

---

#### Phase 1 プロンプト：脱構築の問いかけ

##### P1-1: 二項対立の抽出と特権化の診断

```text
このモデルに含まれる enum 型、boolean フィールド、型階層をすべて列挙せよ。
各対立について以下を表形式で出力せよ:
| 対立 | 特権化されている項 | 特権化の根拠（技術/ビジネス/歴史的経緯） | 排除されている状態・概念 |
```

##### P1-2: 差延の追跡 — 意味を先送りしている境界の発見

```text
各エンティティについて、その意味が曖昧になる隣接概念との境界を列挙せよ。
「これは [EntityA] か [EntityB] か」という問いが生じる境界をすべて挙げ、
その曖昧さが「設計上のバグ」か「ビジネスの複雑さの正直な反映」かを判定せよ。
```

##### P1-3: 痕跡と排除の追跡

```text
各エンティティの「前」と「後」に位置する概念を列挙せよ。
それぞれについて、モデルに明示されているか・排除されているかを示せ。
終端状態（最終ステータス、削除済み）についても、その先に続くビジネスフローがないかを確認せよ。
```

##### P1-4: アクター別集約ルート候補の洗い出し

```text
現在の集約ルートを特定し、その中心性が誰の視点を特権化しているかを明示せよ。
次に、以下のアクターそれぞれにとっての集約ルート候補を列挙せよ:
[対象システムの主要アクターをここに列挙する]
現在の選択との差異を記録し、中心選択の暗黙の前提を言語化せよ。
```

---

#### Phase 2 プロンプト：スキーマ理論の問いかけ

##### P2-1: 支配的スキーマの同定

```text
このモデルが暗黙に採用しているメタファーを「[ドメイン概念] とは [メタファー] である」の形で言語化せよ。
そのメタファーを「当たり前」にしている関係者の職種・立場・経験を特定し、
Phase 1 で発見した排除概念・特権化された二項対立がそのスキーマからどう説明できるかを示せ。
```

##### P2-2: 代替スキーマの構想

```text
同じドメインを別のメタファーで捉えた場合の代替スキーマを最低2つ提案せよ。
各スキーマについて:
- メタファーの言語化（「[ドメイン概念] とは [代替メタファー] である」）
- そのスキーマが自然に扱えるケースと、扱いにくくなるケース
- Phase 1 で発見した排除概念がこのスキーマでどう表現されるか
```

##### P2-3: 同化バイアスの検出と出所の診断

```text
以下のシグナルからモデル内の同化バイアスを特定せよ:
- 本来の意味とずれた命名（フィールド・メソッド名）
- 過度に複雑なバリデーションルール
- 「特殊ケース」「例外処理」が集中する箇所

各バイアスについて、出所を診断せよ:
- 開発者側（技術的惰性・既存コードへの影響最小化）
- ドメインエキスパート側（既存業務フローへの固執・経験スキーマの過適用）
```

##### P2-4: プロトタイプ偏りの評価

```text
このモデルが想定する「典型的なケース（プロトタイプ）」を明示せよ。
次に、非プロトタイプ的なケース（例: 大量一括注文、法人顧客、国際取引）を列挙し、
現在の発生頻度（低/中/高）と将来的な増加見込み（低/中/高）を評価せよ。
```

---

#### Phase 3 プロンプト：再構成の問いかけ

##### P3-1: 代替スキーマによるモデル再構築

```text
Phase 2 で提案した代替スキーマのうち最も有望なものについて、
ドメインモデルの概略を再構築せよ。
Phase 1 で発見した排除概念がこのモデルでどう扱われるかを明示せよ。
```

##### P3-2: 調節コストの見積もり

```text
現行モデルから代替モデルへの調節コストを以下の軸で評価せよ:
| 評価軸 | コスト（低/中/高） | 根拠 |
|影響エンティティ数 | | |
|テスト書き換え範囲 | | |
|API・インターフェース変更 | | |
|チーム合意コスト | | |
|段階的移行可能性 | | |
```

##### P3-3: 推奨アクションの決定

```text
Phase 1〜3 の診断を総合し、以下のいずれかに分類して推奨アクションを示せ:
- 即時調節（コスト低・リスク高）
- 段階的調節（コスト中・リスク中）
- 監視継続（コスト高・リスク低）
推奨の根拠と、次のアクションとして具体的に何をすべきかを明記せよ。
```

---

### 実践例

本ワークフローを `Order` モデルに適用した具体例は `agent-docs/examples/domain-objects.md` の「Order モデルの批判的検討」セクションを参照。

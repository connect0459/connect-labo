# コードレビューガイドライン

## 基本方針

コードレビューは**コードの品質向上とナレッジ共有**を目的とします。批判ではなく、建設的なフィードバックを提供することを心がけます。

## レビュー前の準備

### 1. 変更の全体像を把握する

レビュー対象の全ファイルを読み込み、変更の意図とスコープを理解します。

```bash
# 変更されたファイル一覧を確認
git diff --name-only base-branch...HEAD

# 各ファイルの変更内容を確認
git diff base-branch...HEAD
```

### 2. コンテキストを収集する

- 関連するissue/PRを確認
- コミットメッセージから変更理由を理解
- 既存のコードベースパターンを確認

## レビュー時の原則

### 意図的な設計判断をバグとしてフラグしない

**重要**: 不自然に見えるコードでも、意図的な設計判断である可能性があります。

❌ **避けるべき**:

```markdown
## 指摘事項

- このHTML要素が重複しているのはバグでは？
- `rel="noopener noreferrer"` 属性が欠けています。
```

✅ **推奨**:

```markdown
## 確認事項

- このHTML要素の重複は意図的ですか？（A/Bテスト等の理由があれば教えてください）
- `rel="noopener noreferrer"` 属性の省略は意図的ですか？
```

### バグと仮定する前に質問する

コードが期待と異なる場合、まず**理解を深めるために質問**します。

```markdown
## 質問

- このルーティングケースはどのシナリオで使用されますか？
- この validation ロジックが Controller ではなく Request に配置されている理由を教えてください。
```

### テスト実行の判断

レビュー時のテスト実行は**明示的に指示された場合のみ**行います。

**理由**:

- テスト環境が整っていない場合がある
- CI/CDで自動実行される前提
- 静的解析（コード読解）が基本

❌ **避けるべき**:

```bash
# レビュー中に勝手にテストを実行
npm test
```

✅ **推奨**:

- CIの結果を確認
- テストが必要な場合はユーザーに確認

## レビューの観点

### 1. 重大度による分類

レビューコメントは以下の3つに分類します:

#### Critical（必須修正）

**セキュリティ、データ損失、システム障害に直結する問題**:

- SQLインジェクション、XSS等の脆弱性
- データ破壊のリスク
- レイヤー間の不正な依存

例:

```markdown
## Critical

- ユーザー入力が直接SQLクエリに連結されており、SQLインジェクションのリスクがあります。
  プレースホルダーを使用してください。
```

#### Suggestion（推奨改善）

**コード品質、保守性、パフォーマンスの改善提案**:

- リファクタリング提案
- パフォーマンス最適化
- 命名の改善

例:

```markdown
## Suggestion

- この関数は100行を超えています。責務ごとに分割することで可読性が向上します。
```

#### Nit（些細な指摘）

**コーディングスタイル、タイポ等の軽微な問題**:

- インデントの不統一
- タイポ
- コメントの誤字

例:

```markdown
## Nit

- `valiation` → `validation` のタイポがあります。
```

### 2. レビュー観点のチェックリスト

#### 正確性

- [ ] ビジネスロジックが要件を満たしているか
- [ ] エッジケースが考慮されているか
- [ ] エラーハンドリングが適切か

#### セキュリティ

- [ ] 入力バリデーションが実装されているか
- [ ] 認証・認可が適切か
- [ ] 機密情報がハードコーディングされていないか

#### 保守性

- [ ] コードが理解しやすいか
- [ ] 適切な抽象化レベルか
- [ ] 命名が明確か

#### テスト

- [ ] テストカバレッジが適切か
- [ ] テストが仕様を表現しているか
- [ ] エッジケースがテストされているか

#### パフォーマンス

- [ ] N+1問題がないか
- [ ] 不要な処理が含まれていないか
- [ ] リソース（メモリ、DB接続等）が適切に管理されているか

## レビューコメントの書き方

### 建設的なフィードバック

❌ **避けるべき**:

```markdown
このコードは良くない。
```

✅ **推奨**:

```markdown
この実装では N+1 問題が発生する可能性があります。
JOIN を使用することで1回のクエリに削減できます。

\`\`\`sql
SELECT users.*, posts.*
FROM users
LEFT JOIN posts ON posts.user_id = users.id
\`\`\`
```

### 具体的な改善案を提示

問題を指摘するだけでなく、**具体的な改善案**を提示します。

```markdown
## Suggestion

現在、この関数は複数の責務を持っています:
1. データの取得
2. バリデーション
3. フォーマット

以下のように分割することを推奨します:

\`\`\`typescript
// データ取得
const data = await fetchUserData(userId);

// バリデーション
validateUserData(data);

// フォーマット
return formatUserData(data);
\`\`\`
```

### ポジティブなフィードバックも忘れずに

良いコードには積極的に賞賛のコメントを残します。

```markdown
## 良い点

- エラーハンドリングが丁寧で、ユーザーに分かりやすいメッセージが表示されます。
- テストケースが網羅的で、仕様がよく理解できます。
```

## 完全性の確保

### リファクタリング・リネームのレビュー

リファクタリングやリネーム変更では、**全参照が更新されているか**を確認します。

確認項目:

- [ ] import/export文
- [ ] コンポーネント名
- [ ] テストファイル名・テストケース名
- [ ] Storybook のタイトル・ストーリー名
- [ ] 型定義・インターフェース名
- [ ] ドキュメント・コメント

未更新の参照が見つかった場合:

```markdown
## Critical

以下のファイルで古いコンポーネント名が残っています:

- `src/components/Example.test.tsx` (line 10)
- `src/stories/Example.stories.tsx` (title)
```

### パターンの汎化

エラーメッセージ、validation ロジック等のパターン更新では、**全インスタンス**が更新されているか確認します。

```markdown
## Suggestion

以下のフィールドで古いエラーメッセージパターンが残っています:

- `passwordField` (line 45)
- `prefectureField` (line 78)

他のフィールドと同様に汎化されたメッセージを使用してください。
```

## レビュー結果の出力

### 構造化されたレビュー

レビュー結果は以下の構造で出力します:

```markdown
# PR Review: [PR番号/タイトル]

## Summary

[変更の概要を2-3文で記述]

## Critical Issues

[必須修正項目]

## Suggestions

[推奨改善項目]

## Questions

[確認事項]

## Nits

[些細な指摘]

## Positive Feedback

[良い点の賞賛]
```

## Coding Agentでのレビューワークフロー

### 1. レビュー開始

```text
PR #123 をレビューしてください。

レビュールール:
1. 全変更ファイルを読み込んでから開始
2. テストは実行しない
3. 不自然なコードは質問してから判断
4. 結果を tmp/pr-review.md に出力
```

### 2. 構造化レビューの実施

- 全ファイルを読み込み
- 変更の意図を理解
- 観点別にレビュー
- 重大度で分類

### 3. レビュー結果の確認

出力されたレビューを確認し、必要に応じて追加質問やコンテキストの提供を行います。

## まとめ

- **意図を理解する**: バグと仮定する前に質問する
- **建設的に**: 批判ではなく改善提案を提供
- **完全性を確認**: リファクタリングでは全参照の更新を確認
- **重大度で分類**: Critical / Suggestion / Nit で優先度を明確化
- **ポジティブに**: 良いコードには賞賛を忘れずに

---

**参考資料**:

- `dev-settings/claude/agent-docs/conventions/code-comments.md` - コメント規約
- `dev-settings/claude/agent-docs/testing/tdd-workflow.md` - テスト戦略

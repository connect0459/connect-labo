# uv.lock と pylock.toml の構造比較分析レポート

**実施日**: 2025年11月28日
**分析対象**: 同一の `pyproject.toml` から生成されたロックファイルの比較
**プロジェクト**: pep751 (依存関係: requests, numpy, pandas)

---

## 目次

1. [概要](#概要)
2. [実験環境と手法](#実験環境と手法)
3. [基本統計情報](#基本統計情報)
4. [構造的差異の詳細分析](#構造的差異の詳細分析)
5. [具体例による比較](#具体例による比較)
6. [設計思想の違い](#設計思想の違い)
7. [ユースケースと推奨事項](#ユースケースと推奨事項)
8. [参考資料との整合性検証](#参考資料との整合性検証)

---

## 概要

本レポートは、Astral社の `uv` パッケージマネージャーが生成する独自形式のロックファイル (`uv.lock`) と、Python公式コミュニティ (PyPA) が策定したPEP 751標準形式のロックファイル (`pylock.toml`) の構造的差異を実証的に分析したものである。

同一のプロジェクト定義 (`pyproject.toml`) から両形式のロックファイルを生成し、その構造、メタデータ、依存関係表現の違いを詳細に比較することで、両フォーマットの設計思想と実用上の特性を明らかにする。

---

## 実験環境と手法

### プロジェクト構成

```toml
[project]
name = "pep751"
version = "0.1.0"
requires-python = ">=3.11"
dependencies = [
    "requests",
    "numpy",
    "pandas",
]
```

### 生成手順

1. **uv.lock の生成**:

   ```bash
   uv add requests numpy pandas
   # 自動的に uv.lock が生成される
   ```

2. **pylock.toml の生成**:

   ```bash
   uv export --format pylock.toml -o pylock.toml
   ```

### 解決された依存関係

| 直接依存 | 推移的依存 | 合計パッケージ数 |
|---------|-----------|---------------|
| 3 | 8 | 11 |

**パッケージ一覧**:

- certifi
- charset-normalizer
- idna
- numpy
- pandas
- python-dateutil
- pytz
- requests
- six
- tzdata
- urllib3

---

## 基本統計情報

| 項目 | uv.lock | pylock.toml | 差異 |
|------|---------|-------------|------|
| **ファイルサイズ** | 313行 | 263行 | -50行 (-16.0%) |
| **パッケージエントリ** | 12個 (`[[package]]`) | 11個 (`[[packages]]`) | -1個 |
| **総文字数 (概算)** | ~33,000文字 | ~27,000文字 | -18.2% |
| **フォーマット** | uv独自 (TOMLベース) | PEP 751標準 | - |

**注**: uv.lockのパッケージ数が1つ多いのは、内部管理用のメタエントリが含まれる可能性がある。

---

## 構造的差異の詳細分析

### 1. ヘッダーセクション

#### uv.lockのヘッダーセクション

```toml
version = 1
revision = 2
requires-python = ">=3.11"
resolution-markers = [
    "python_full_version >= '3.12'",
    "python_full_version < '3.12'",
]
```

**特徴**:

- `version`: ロックファイル形式のバージョン
- `revision`: 解決アルゴリズムのリビジョン (uvの内部バージョン管理)
- `resolution-markers`: **ユニバーサルロック**の核心機能
  - 複数のPythonバージョンに対する解決結果を単一ファイルに格納
  - クロスプラットフォーム互換性の基盤

#### pylock.tomlのヘッダーセクション

```toml
# This file was autogenerated by uv via the following command:
#    uv export --format pylock.toml -o pylock.toml
lock-version = "1.0"
created-by = "uv"
requires-python = ">=3.11"
```

**特徴**:

- `lock-version`: PEP 751標準のバージョン番号
- `created-by`: 生成ツールの明示 (相互運用性の観点で重要)
- 生成コマンドのコメント付き (再現性向上)
- `resolution-markers` は含まれない (標準仕様外)

**設計思想の違い**:

- uv.lockは「開発者のための完全な状態保存」
- pylock.tomlは「インストーラーのための静的な指示書」

---

### 2. セクション名の命名規則

| ファイル | セクション名 | PEP 751準拠 |
|---------|------------|------------|
| uv.lock | `[[package]]` (単数形) | ✗ |
| pylock.toml | `[[packages]]` (複数形) | ✓ |

PEP 751は `[[packages]]` を標準として定義している。uvは独自の内部最適化のため異なる命名を採用。

---

### 3. パッケージソースの表現

#### uv.lockのパッケージソース

```toml
[[package]]
name = "certifi"
version = "2025.11.12"
source = { registry = "https://pypi.org/simple" }
```

**`source` オブジェクト**:

- より柔軟な表現が可能
- Git、ローカルパス、プライベートレジストリなど多様なソースタイプに対応
- uvの拡張機能 (例: `source = { git = "..." }`) をサポート

#### pylock.tomlのパッケージソース

```toml
[[packages]]
name = "certifi"
version = "2025.11.12"
index = "https://pypi.org/simple"
```

**`index` 文字列**:

- シンプルで標準化された表現
- PEP 751仕様に準拠
- 主にPyPI互換のインデックスを想定

---

### 4. 依存関係グラフの表現 (最重要な差異)

#### uv.lock: 明示的な依存関係グラフ

```toml
[[package]]
name = "pandas"
version = "2.3.3"
source = { registry = "https://pypi.org/simple" }
dependencies = [
    { name = "numpy" },
    { name = "python-dateutil" },
    { name = "pytz" },
    { name = "tzdata" },
]
sdist = { ... }
wheels = [ ... ]
```

**特徴**:

- 各パッケージの `dependencies` セクションで依存関係を明示
- 依存関係グラフを直接トラバース可能
- 高速な解決再現と検証が可能

#### pylock.toml: 依存関係情報の省略

```toml
[[packages]]
name = "pandas"
version = "2.3.3"
index = "https://pypi.org/simple"
sdist = { ... }
wheels = [ ... ]
```

**特徴**:

- パッケージレベルでの `dependencies` セクションなし
- PEP 751の最終仕様では、グラフ情報は別の方法で表現される設計
  - `[[groups]]` テーブルによる「エントリーポイント」方式
  - 本実験ではこのセクションが生成されていない可能性 (ツール実装依存)

**考察**:
ドキュメント「PythonパッケージマネージャーとPEP751.md」では、PEP 751が依存関係グラフを保持すると記載されているが、本実験で生成された pylock.toml には明示的な依存関係情報が含まれていない。これは以下の理由が考えられる:

1. uvのエクスポート機能が簡略版を出力している
2. PEP 751の `[[groups]]` テーブルが別途必要だが、本プロジェクトでは生成されていない
3. 依存関係はメタデータから推論可能なため省略されている

---

### 5. メタデータの詳細度

#### タイムスタンプの精度

| ファイル | 形式 | 例 |
|---------|------|---|
| uv.lock | ISO 8601 (ミリ秒付き) | `"2025-11-12T02:54:51.517Z"` |
| pylock.toml | ISO 8601 (秒単位) | `2025-11-12T02:54:51Z` |

**意義**:

- uv.lockは再現性のために高精度タイムスタンプを保持
- pylock.tomlは相互運用性のために標準的な精度で十分

#### ハッシュの表現

**uv.lock**:

```toml
{ url = "...", hash = "sha256:d8ab5478...", size = 160538 }
```

**pylock.toml**:

```toml
{ url = "...", hashes = { sha256 = "d8ab5478..." }, size = 160538 }
```

**違い**:

- uv.lock: `hash` (文字列、プレフィックス付き)
- pylock.toml: `hashes` (オブジェクト、アルゴリズムを明示)

PEP 751は将来的にSHA-256以外のハッシュアルゴリズムをサポートするため、オブジェクト形式を採用。

---

### 6. ホイール配列の記述スタイル

#### uv.lock: 可読性重視

```toml
wheels = [
    { url = "https://...", hash = "sha256:...", size = 159438, upload-time = "..." },
]
```

- 1行で記述されるが、構造が明確
- 複数のホイールがある場合は複数行に展開

#### pylock.toml: 簡潔性重視

```toml
wheels = [{ url = "https://...", upload-time = 2025-11-12T02:54:49Z, size = 159438, hashes = { sha256 = "..." } }]
```

- ホイールが1つの場合は1行
- 複数の場合は配列として展開

---

## 具体例による比較

### certifi パッケージ (シンプルなケース)

#### uv.lock

```toml
[[package]]
name = "certifi"
version = "2025.11.12"
source = { registry = "https://pypi.org/simple" }
sdist = {
    url = "https://files.pythonhosted.org/packages/.../certifi-2025.11.12.tar.gz",
    hash = "sha256:d8ab5478f2ecd78af242878415affce761ca6bc54a22a27e026d7c25357c3316",
    size = 160538,
    upload-time = "2025-11-12T02:54:51.517Z"
}
wheels = [
    {
        url = "https://files.pythonhosted.org/packages/.../certifi-2025.11.12-py3-none-any.whl",
        hash = "sha256:97de8790030bbd5c2d96b7ec782fc2f7820ef8dba6db909ccf95449f2d062d4b",
        size = 159438,
        upload-time = "2025-11-12T02:54:49.735Z"
    },
]
```

#### pylock.toml

```toml
[[packages]]
name = "certifi"
version = "2025.11.12"
index = "https://pypi.org/simple"
sdist = {
    url = "https://files.pythonhosted.org/packages/.../certifi-2025.11.12.tar.gz",
    upload-time = 2025-11-12T02:54:51Z,
    size = 160538,
    hashes = { sha256 = "d8ab5478f2ecd78af242878415affce761ca6bc54a22a27e026d7c25357c3316" }
}
wheels = [{
    url = "https://files.pythonhosted.org/packages/.../certifi-2025.11.12-py3-none-any.whl",
    upload-time = 2025-11-12T02:54:49Z,
    size = 159438,
    hashes = { sha256 = "97de8790030bbd5c2d96b7ec782fc2f7820ef8dba6db909ccf95449f2d062d4b" }
}]
```

**差異のまとめ**:

1. `source` vs `index`
2. `hash` (文字列) vs `hashes` (オブジェクト)
3. タイムスタンプの精度
4. 依存関係セクションなし (certifiは依存なしパッケージのため両者共になし)

---

### charset-normalizer パッケージ (クロスプラットフォーム対応)

このパッケージは、多数のプラットフォーム用のホイールを持つため、ユニバーサルロックの真価が問われる。

**ホイール数**:

- macOS (x86_64, arm64): 2種類
- Linux (aarch64, armv7l, ppc64le, s390x, x86_64, riscv64): 多数
- musllinux: 追加で複数
- Windows (win32, amd64, arm64): 3種類
- Python 3.11, 3.12, 3.13, 3.14対応

**合計**: 約80個のホイール

#### 両形式での対応

**uv.lock**: 全プラットフォームのホイールを単一ファイルに格納し、`resolution-markers` で環境を識別。

**pylock.toml**: 同様に全ホイールを格納するが、マーカー情報は省略。インストーラーが環境に応じて適切なホイールを選択する想定。

**結論**: 両形式ともクロスプラットフォーム対応だが、uv.lockは解決時の情報も保持するため、より詳細。

---

## 設計思想の違い

### uv.lock: 開発者中心の完全性

**目的**:

- 開発環境の完全な再現
- 依存関係解決プロセスの透明性
- uvツールチェーンとの緊密な統合

**特徴**:

1. **依存関係グラフの明示**: 各パッケージの依存を直接記述
2. **解決マーカー**: 複数環境での解決結果を保持
3. **高精度メタデータ**: ミリ秒単位のタイムスタンプ
4. **内部最適化**: uvの高速リゾルバに最適化された構造

**ユースケース**:

- モノレポ・ワークスペース管理
- 厳格な再現性が求められる本番環境
- CI/CDパイプラインでの高速ビルド

---

### pylock.toml: 相互運用性の標準化

**目的**:

- ツール間の相互運用性
- 標準化による長期的な保守性
- インストール再現性の担保

**特徴**:

1. **シンプルな構造**: 必要最小限の情報
2. **標準準拠**: PEP 751仕様に厳密に従う
3. **ツール非依存**: uvだけでなく、pip, PDM, Poetryなどでも読み取り可能
4. **エクスポート形式**: uv.lockからの変換出力として機能

**ユースケース**:

- マルチツール環境でのプロジェクト管理
- セキュリティスキャンツールへの入力
- クラウドプロバイダのビルドパック (GCP, AWS, Azure)
- 教育・標準化を重視するプロジェクト

---

## ユースケースと推奨事項

### シナリオ別推奨

| シナリオ | 推奨フォーマット | 理由 |
|---------|----------------|------|
| **uvのみを使用するプロジェクト** | uv.lock | 完全な機能と高速性を享受 |
| **モノレポ・ワークスペース** | uv.lock | ワークスペース機能が必須 |
| **マルチツール環境** | pylock.toml (エクスポート) | 相互運用性の確保 |
| **Dependabot等のセキュリティスキャン** | pylock.toml | 標準フォーマット対応 |
| **CI/CD高速化が最優先** | uv.lock | uvのキャッシュ機構を最大活用 |
| **長期保守・標準準拠重視** | pylock.toml | PEP準拠で将来性確保 |

### ベストプラクティス

#### 開発フローでの併用

1. **日常の開発**: `uv.lock` をメインに使用

   ```bash
   uv sync
   uv add <package>
   ```

2. **CI/CD後段でエクスポート**: `pylock.toml` を生成・保存

   ```bash
   uv export --format pylock.toml -o pylock.toml
   git add pylock.toml
   git commit -m "chore: update pylock.toml for interoperability"
   ```

3. **セキュリティ監査**: pylock.tomlをスキャンツールに提供

---

## 参考資料との整合性検証

### ドキュメント「PythonパッケージマネージャーとPEP751.md」の主張

#### ✅ 検証された内容

1. **uv.lockはユニバーサル**:
   - 確認: `resolution-markers` と複数プラットフォームのホイールを確認

2. **PEP 751は標準化**:
   - 確認: `lock-version`, `[[packages]]` 等の標準準拠を確認

3. **uvはワークスペースをサポート、PEP 751はスコープ外**:
   - 本実験では単一プロジェクトのため直接検証不可だが、構造から推測可能

#### ⚠️ 要追加検証の内容

1. **PEP 751の依存関係グラフ**:
   - ドキュメント: 「グラフ構造を保持する」
   - 実験結果: 生成されたpylock.tomlに明示的なグラフ情報なし
   - 可能性: `[[groups]]` テーブルが必要だが、今回は生成されず

#### 追加調査の推奨

```bash
# より複雑なプロジェクトでのテスト
uv init --lib complex-project
cd complex-project
uv add "fastapi[all]" "sqlalchemy[asyncio]"
uv export --format pylock.toml -o pylock.toml
# [[groups]] セクションの有無を確認
```

---

## 結論

### 主要な発見

1. **ファイルサイズ**: pylock.tomlはuv.lockより約16%小さい
2. **依存関係グラフ**: uv.lockは明示的、pylock.tomlは省略 (仕様上は別方式で表現可能)
3. **メタデータ精度**: uv.lockがより詳細
4. **標準準拠**: pylock.tomlがPEP 751に完全準拠
5. **相互運用性**: pylock.tomlが他ツールとの連携に優位

### ドキュメント分析報告書の結論との整合性

> "2025年11月27日の時点で、Pythonパッケージマネジメントの勝者は技術的に見て **uv** であることは疑いようがない"

**本実験からの追加知見**:

- uvは **uv.lock** という独自形式で最大のパフォーマンスと機能性を実現
- 同時に **pylock.toml (PEP 751)** へのエクスポート機能で相互運用性も担保
- この「二刀流」戦略により、uvはエコシステムの支配的地位と標準化の両立を図っている

### 最終推奨

**開発チームへの提言**:

1. **メインロックファイル**: `uv.lock` を使用
2. **標準出力**: `pylock.toml` を定期的にエクスポート・コミット
3. **ツール依存のリスク軽減**: `pyproject.toml` をPEP 621に厳密に準拠させる
4. **CI/CD**: uvの高速性を活用しつつ、pylock.tomlをアーティファクトとして保存

**今後の展望**:

- PEP 751の実装がさらに成熟すれば、より多くのツールが対応
- uvの独占リスクを軽減しつつ、現時点での最高のツールを活用
- 「標準」と「実装」のバランスを取ることが2025年以降の最適解

---

## 付録

### 生成されたファイル

- `/Users/akira/workspaces/repo/connect-labo/workspaces/python/pep751/uv.lock` (313行)
- `/Users/akira/workspaces/repo/connect-labo/workspaces/python/pep751/pylock.toml` (263行)
- `/Users/akira/workspaces/repo/connect-labo/workspaces/python/pep751/pyproject.toml`

### 関連リソース

- [PEP 751 – A file format to record Python dependencies](https://peps.python.org/pep-0751/)
- [uv Documentation](https://docs.astral.sh/uv/)
- [参考ドキュメント: PythonパッケージマネージャーとPEP751.md](./PythonパッケージマネージャーとPEP751.md)

---

**作成者**: Claude Code
**最終更新**: 2025年11月28日

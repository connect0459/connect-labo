# Qwik イベントハンドラセキュリティ検証レポート

## 検証の目的

Qwikフレームワークにおいて、`on:click`属性などのイベントハンドラに悪意のある値を埋め込まれた場合の挙動を検証します。

## 検証環境

- Qwikバージョン: 1.17.1
- Node.js: v18.17.0以上
- 検証日: 2025-10-31

## 検証シナリオ

### 1. 正常なケース

通常のQwikイベントハンドラの動作を確認します。

**実装:**

```tsx
const normalClick$ = $(() => {
  console.log("Normal click handler executed");
});

<button onClick$={normalClick$}>正常なボタン</button>
```

**期待される結果:** クリック時にイベントハンドラが実行される

### 2. 存在しないファイルパスを指定

**実装:**

```html
<button on:click="/non-existent-file#handleClick">
  存在しないファイルパスを指定したボタン
</button>
```

**検証内容:**

- `on:click`属性に存在しないファイルパスを指定した場合の挙動
- Qwikがビルド時にこのパスを解決しようとするか
- 実行時にエラーが発生するか

**期待される結果:**

- ビルド時またはランタイム時にエラーが発生する、または
- イベントハンドラが単に機能しない（無視される）

### 3. ディレクトリトラバーサルを試みる

**実装:**

```html
<button on:click="../../../../etc/passwd#maliciousHandler">
  ディレクトリトラバーサルを試みるボタン
</button>
```

**検証内容:**

- ディレクトリトラバーサルを含むパスがQwikによってどう処理されるか
- システムファイルへのアクセスが可能か

**期待される結果:**

- パスが正規化され、システムファイルへのアクセスは不可能
- イベントハンドラが機能しない

### 4. 悪意のあるイベントリスナー名（XSS試行）

**実装:**

```html
<button on:click="/malicious-file#eval(alert('XSS'))">
  悪意のあるイベントリスナー名を指定したボタン
</button>
```

**検証内容:**

- イベントリスナー名に特殊文字や関数呼び出しを含めた場合の挙動
- XSS攻撃が成功するか

**期待される結果:**

- イベントリスナー名は文字列として扱われ、コードとして実行されない
- XSS攻撃は失敗する

### 5. プロトコルハンドラを試みる

**実装:**

```html
<button on:click="javascript:alert('XSS')">
  javascript:プロトコルを試みるボタン
</button>
```

**検証内容:**

- `javascript:`プロトコルを使用した場合の挙動
- 任意のJavaScriptコードが実行されるか

**期待される結果:**

- `javascript:`プロトコルは無視される、または
- Qwikのイベントハンドラとして認識されず、何も実行されない

## Qwikのセキュリティメカニズム

### ビルド時の静的解析

Qwikは以下の特徴を持ちます：

1. **ビルド時解析**: Qwikはビルド時にイベントハンドラを解析し、必要なコードを自動的に分割します
2. **静的な参照**: `on:click`属性はビルド時に解決される必要があり、動的な値は基本的にサポートされていません
3. **Lazy Loading**: イベントハンドラは必要になるまで読み込まれませんが、参照はビルド時に確定します

### dangerouslySetInnerHTMLの影響

`dangerouslySetInnerHTML`を使用してHTMLを挿入した場合：

- HTMLマークアップとしては挿入されます
- しかし、Qwikのイベントハンドラとしては**認識されません**
- これは、Qwikがビルド時にコンポーネントツリーを解析し、イベントハンドラの参照を確立するためです
- 実行時に追加された`on:click`属性は、Qwikのリスナーシステムに登録されません

## 検証方法

### 開発サーバーの起動

```bash
cd workspaces/js/qwik-vulnerability
npm run dev
```

### 検証ページへのアクセス

1. ブラウザで `http://localhost:5173/security-test` にアクセス
2. 各テストケースのボタンをクリック
3. ブラウザの開発者ツールを開き、以下を確認：
   - コンソールログ
   - ネットワークタブ（不正なリクエストが発生していないか）
   - エラーメッセージ

## 予想される結果

### 正常なボタン

- ✅ クリック時にログが表示される
- ✅ イベントハンドラが正常に実行される

### 不正な属性を持つボタン（2〜5）

- ✅ クリックしても何も起こらない
- ✅ コンソールにエラーが表示される、または何も表示されない
- ✅ 悪意のあるコードは実行されない
- ✅ 不正なネットワークリクエストは発生しない

## セキュリティ上の推奨事項

1. **dangerouslySetInnerHTMLの使用を避ける**: 可能な限りQwikのコンポーネントシステムを使用する
2. **ユーザー入力のサニタイズ**: ユーザーからの入力をHTMLとしてレンダリングする前に必ずサニタイズする
3. **Content Security Policy（CSP）の設定**: XSS攻撃を防ぐためにCSPを適切に設定する
4. **定期的なセキュリティ監査**: 依存関係のセキュリティ脆弱性を定期的にチェックする

## 結論

Qwikのアーキテクチャは、以下の理由からこの種の攻撃に対して比較的安全です：

1. **ビルド時解析**: イベントハンドラはビルド時に解決されるため、実行時の動的な挿入は機能しない
2. **静的参照**: `on:click`属性の値は静的に解析される必要があり、任意のパスは無視される
3. **分離されたイベントシステム**: Qwikのイベントシステムは、HTMLの`onclick`属性とは独立しており、より安全

ただし、`dangerouslySetInnerHTML`などのAPIを使用する際は、常に注意が必要です。

## ファイル一覧

検証用に作成されたファイル：

- `src/routes/security-test/index.tsx` - セキュリティ検証ページ
- `src/malicious-file.ts` - 疑似的な悪意のあるファイル（検証目的）
- `SECURITY_TEST_REPORT.md` - このレポート

## 参考資料

- [Qwik公式ドキュメント](https://qwik.builder.io/)
- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [Content Security Policy Reference](https://content-security-policy.com/)

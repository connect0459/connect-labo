# monorepo のテストを早くしたい！〜最小の依存解決への道のり〜

- テストやってる？
  - どんどん遅くなっていく
- monorepoのメリット
  - レポジトリの膨張速度は速い
  - 諸問題の顕在化が早い
- 早くするための手法
  - コードを小さくする
  - 不要なテストケースを減らす
  - キャッシュする
  - 実行箇所の限定
- 実行箇所を限定した差分テスト
  - どうやって差分テストをやるか
  - 変更した差分を起点に依存を解決させていけば最小実行が理論上できる
- パッケージ単位の差分解決
  - パッケージ単位のimport graphを構築
    - `x/tools/go/packages`をから依存関係を読み込み、木構造に整形
  - 変更パッケージから到達可能なパッケージをリスト
- 処理の流れざっくり
  - 変更の特定
    - GitHub CLIを使って特定
  - 影響分析
  - 選択的テスト実行
- 今の困りごと
  - 特大パッケージが出たとき、それだけで時間を食う
  - より中心側のpkg（domainなど）が変更されると、repository（persistence）、service、handlerなどなど全部含まれる可能性がある
- さらに絞る場合
  - pkg単位でなく、関数単位で区切ることができれば早くなりそう
- 関数単位の解決を実施する上での課題
  - `x/tools/go/packages`はASTも要求できるが、素朴な探索は時間がかかりそう
  - Go本体の機構も参考にできれば
